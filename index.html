<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Club Quiz Royale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .view {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .view.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 500px;
        }
        .btn {
            display: inline-block;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
            cursor: pointer;
            text-align: center;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        .option-btn {
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        .option-btn:hover {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        .option-btn.selected {
            border-color: #4f46e5;
            background-color: #c7d2fe;
            font-weight: 600;
        }
        .option-btn.correct {
            background-color: #dcfce7;
            border-color: #22c55e;
        }
        .option-btn.incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
        }
        .input-field.uppercase {
            text-transform: uppercase;
        }
        .input-field.uppercase::placeholder {
            text-transform: none;
        }
        /* Podium Styles */
        .podium-stand {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            width: 32%;
            padding: 1rem;
            border-radius: 0.75rem 0.75rem 0 0;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            text-align: center;
            transition: all 0.3s ease-in-out;
            color: #1f2937;
        }
        .podium-name {
            font-weight: 700;
            font-size: 1.125rem;
            word-break: break-word;
        }
        .podium-score {
            font-weight: 600;
            font-size: 1rem;
            color: #4f46e5;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- App Container -->
    <div id="app-container" class="w-full h-full">

        <!-- Initial Screen: Host or Join -->
        <div id="initial-view" class="view active flex-col items-center justify-center h-full">
            <div class="card text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">Book Club Quiz Royale</h1>
                <p class="text-gray-600 mb-8">Create a game for your book club or join an existing one.</p>
                
                <div class="space-y-4 mt-4">
                    <button id="host-game-btn" class="btn btn-primary w-full">Host New Game</button>
                    <button id="join-game-btn" class="btn btn-secondary w-full">Join Game</button>
                    <button id="how-to-play-btn" class="btn btn-secondary w-full">How to Play</button>
                </div>
                 <div class="mt-8 text-sm text-gray-500">
                    <p>Your User ID (for reference):</p>
                    <p id="user-id-display" class="font-mono bg-gray-200 rounded p-1 inline-block mt-1"></p>
                </div>
            </div>
        </div>
        
        <!-- How to Play View -->
        <div id="how-to-play-view" class="view flex-col items-center justify-center h-full">
            <div class="card">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">How to Play</h2>
                <div class="space-y-4 text-gray-700">
                    <div>
                        <h3 class="font-bold text-lg text-indigo-600">Phase 1: Question Submission</h3>
                        <p>The host sets a timer. All players must create and submit quiz questions based on the book. You cannot answer your own questions later, so be creative!</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-indigo-600">Phase 2: The Quiz</h3>
                        <p>Once the submission time is up, the quiz begins! You will be shown questions written by other players, one by one. Answer as many as you can before the main game timer runs out.</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-indigo-600">Scoring System</h3>
                        <ul class="list-disc list-inside space-y-1 mt-2">
                            <li><span class="font-semibold text-green-600">+10 Points</span> for each question you submit.</li>
                            <li><span class="font-semibold text-green-600">+10 Points</span> for each question you answer correctly.</li>
                            <li>There is no penalty for wrong answers.</li>
                        </ul>
                    </div>
                    <p class="font-semibold text-center pt-4">The player with the highest total score wins. Good luck!</p>
                </div>
                <button id="back-to-initial-btn-rules" class="btn btn-primary w-full mt-8">Got it!</button>
            </div>
        </div>

        <!-- Host Setup View -->
        <div id="host-setup-view" class="view flex-col items-center justify-center h-full">
            <div class="card">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Game Setup</h2>
                
                <label for="host-name-input" class="font-semibold text-gray-700">Your Name (as Host)</label>
                <input type="text" id="host-name-input" class="input-field" placeholder="Enter your name..." required>

                <label for="submission-time" class="font-semibold text-gray-700">Question Submission Time (minutes)</label>
                <input type="number" id="submission-time" class="input-field" value="10" min="1">
                
                <label for="total-play-time" class="font-semibold text-gray-700">Total Play Time (minutes)</label>
                <input type="number" id="total-play-time" class="input-field" value="15" min="1">

                <button id="create-game-btn" class="btn btn-primary w-full mt-4">Create Game & Start Lobby</button>
                <button id="back-to-initial-btn-host" class="btn btn-secondary w-full mt-2">Back</button>
            </div>
        </div>

        <!-- Player Join View -->
        <div id="player-join-view" class="view flex-col items-center justify-center h-full">
            <div class="card">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Join a Game</h2>
                
                <label for="join-player-name-input" class="font-semibold text-gray-700">Your Name</label>
                <input type="text" id="join-player-name-input" class="input-field" placeholder="Enter your name..." required>

                <label for="game-id-input" class="font-semibold text-gray-700">Enter Game ID</label>
                <input type="text" id="game-id-input" class="input-field uppercase" placeholder="e.g. AB12C" maxlength="5">
                
                <button id="submit-join-game-btn" class="btn btn-primary w-full">Join</button>
                <button id="back-to-initial-btn-join" class="btn btn-secondary w-full mt-2">Back</button>
            </div>
        </div>

        <!-- Lobby View -->
        <div id="lobby-view" class="view flex-col items-center justify-center h-full">
            <div class="card text-center">
                <h2 id="lobby-title" class="text-3xl font-bold text-gray-800 mb-2">Game Lobby</h2>
                
                <div id="invite-container">
                    <p class="text-gray-600 mb-4">Share the link or scan the QR code to invite players!</p>
                    <div class="flex items-center justify-center space-x-2 bg-gray-200 p-3 rounded-lg">
                        <span id="game-id-display" class="font-mono text-lg text-gray-800"></span>
                        <button id="copy-game-id-btn" class="btn btn-secondary btn-sm py-1 px-3">Copy Link</button>
                    </div>
                    <div id="qrcode" class="mx-auto my-4 w-40 h-40 border p-1 rounded-lg bg-white"></div>
                </div>

                <h3 class="font-semibold text-gray-700 mb-2">Host: <span id="host-name-display" class="font-normal"></span></h3>

                <h3 class="font-semibold text-gray-700 mb-2 mt-4">Players Joined:</h3>
                <div id="player-list" class="space-y-2 text-left bg-gray-50 p-4 rounded-lg min-h-[100px]">
                    <!-- Player names will be injected here -->
                </div>
                
                <div id="host-controls" class="hidden mt-6">
                    <button id="start-game-btn" class="btn btn-primary w-full">Start Question Submission</button>
                </div>
                 <div id="player-wait-message" class="mt-6 text-gray-500">
                    The host will start the game soon.
                </div>
            </div>
        </div>

        <!-- Question Submission View -->
        <div id="question-submission-view" class="view flex-col items-center justify-center h-full">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="submission-view-title" class="text-2xl font-bold text-gray-800">Submit Your Questions</h2>
                    <div class="text-lg font-bold bg-indigo-100 text-indigo-700 rounded-full px-4 py-2">
                        <span id="submission-timer">10:00</span>
                    </div>
                </div>
                
                <!-- This container will hold either the player form or the host's view -->
                <div id="submission-content-container">
                    
                    <!-- Player's View: The Form -->
                    <div id="player-submission-content">
                        <p class="text-gray-600 mb-6">Create a question with four options. Make sure to mark the correct one!</p>
                        <form id="question-form">
                            <label class="font-semibold">Question:</label>
                            <input type="text" id="question-text" class="input-field" required>
                            
                            <label class="font-semibold">Options:</label>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <input type="text" id="option-a" placeholder="Option A" class="input-field m-0" required>
                                <input type="text" id="option-b" placeholder="Option B" class="input-field m-0" required>
                                <input type="text" id="option-c" placeholder="Option C" class="input-field m-0" required>
                                <input type="text" id="option-d" placeholder="Option D" class="input-field m-0" required>
                            </div>

                            <label class="font-semibold">Correct Answer:</label>
                            <select id="correct-answer" class="input-field">
                                <option value="A">Option A</option>
                                <option value="B">Option B</option>
                                <option value="C">Option C</option>
                                <option value="D">Option D</option>
                            </select>

                            <button type="submit" class="btn btn-primary w-full mt-2">Submit Question</button>
                        </form>
                        <div class="mt-4 text-center">
                            <p class="text-gray-700">You have submitted <span id="questions-submitted-count" class="font-bold">0</span> questions.</p>
                        </div>
                    </div>

                    <!-- Host's View: The Question List -->
                    <div id="host-submission-content" class="hidden">
                        <p class="text-gray-600 mb-6 text-center">Players are submitting questions. You can review them in real-time below.</p>
                        <div class="text-center mb-4">
                            <p class="text-lg">Total Questions Submitted:</p>
                            <span id="total-questions-submitted" class="font-bold text-3xl text-indigo-600">0</span>
                        </div>
                        <h3 class="font-bold text-lg text-gray-800 border-t pt-4">Submitted Questions:</h3>
                        <div id="submitted-questions-list" class="mt-2 space-y-3 max-h-80 overflow-y-auto p-3 bg-gray-50 rounded-lg border">
                            <!-- Questions will be dynamically inserted here -->
                        </div>
                    </div>

                </div>
            </div>
        </div>
        
        <!-- Gameplay View (For Players) -->
        <div id="gameplay-view" class="view flex-col items-center justify-center h-full">
            <div class="card w-full max-w-2xl text-center">
                 <div id="question-container">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-500">Question <span id="current-question-number">1</span>/<span id="total-questions-number">10</span></h2>
                        <div class="text-lg font-bold bg-indigo-100 text-indigo-700 rounded-full px-4 py-2">
                           Time Left: <span id="game-timer">15:00</span>
                        </div>
                    </div>
                    <p id="game-question-text" class="text-2xl font-semibold text-gray-800 mb-8 min-h-[60px]"></p>
                    <div id="game-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                       <!-- Options will be injected here -->
                    </div>
                    <div id="feedback-message" class="mt-6 text-xl font-bold"></div>
                </div>
                 <div id="waiting-for-questions" class="text-center p-8 hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Get Ready!</h2>
                    <p class="text-gray-600">The quiz is about to begin. No questions were submitted by other players for you yet. Waiting...</p>
                </div>
                <div id="player-finished-container" class="text-center p-8 hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">You're Done! 🎉</h2>
                    <p class="text-gray-600">Great job! You've answered all available questions. Please wait for the host to end the game for everyone.</p>
                </div>
            </div>
        </div>

        <!-- Host Gameplay View (New) -->
        <div id="host-gameplay-view" class="view flex-col items-center justify-center h-full">
            <div class="card w-full max-w-lg text-center">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Game in Progress</h2>
                    <div class="text-lg font-bold bg-indigo-100 text-indigo-700 rounded-full px-4 py-2">
                       Time Left: <span id="host-game-timer">15:00</span>
                    </div>
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Live Leaderboard</h3>
                <div id="live-leaderboard-list" class="space-y-2 text-left bg-gray-50 p-4 rounded-lg min-h-[200px]">
                    <!-- Live scores will be injected here -->
                </div>
                <button id="end-game-now-btn" class="btn btn-secondary w-full mt-8">End Game For All Players</button>
            </div>
        </div>

        <!-- Scoreboard View -->
        <div id="scoreboard-view" class="view flex-col items-center justify-center h-full">
            <div class="card text-center w-full max-w-lg">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Final Scores</h2>
                
                <div id="podium-container" class="flex items-end justify-center gap-2 md:gap-4 h-64 mb-8">
                    <!-- 2nd Place -->
                    <div id="podium-2" class="podium-stand" style="height: 75%; background-color: #d1d5db; order: 1;"></div>
                    <!-- 1st Place -->
                    <div id="podium-1" class="podium-stand" style="height: 100%; background-color: #fef08a; order: 2; border: 3px solid #facc15;"></div>
                    <!-- 3rd Place -->
                    <div id="podium-3" class="podium-stand" style="height: 60%; background-color: #fcd34d; order: 3;"></div>
                </div>

                <div id="runners-up-list" class="space-y-2 text-left">
                    <!-- Scores for 4th+ will be injected here -->
                </div>

                <button id="play-again-btn" class="btn btn-primary w-full mt-8 hidden">End Game & Return to Menu</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, updateDoc, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- App State ---
        let db, auth;
        let userId;
        let currentGameId = null;
        let currentGameData = null; // Store current game data globally
        let gameUnsubscribe = null;
        let countdownTimer = null;
        let playerQuestions = [];
        let currentQuestionIndex = 0;
        let gameplayTimer = null;
        let isPlayerFinished = false; // Player-specific state to prevent quiz reset

        // --- Firebase Config ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
          apiKey: "AIzaSyARY3zVYRUVO1wGxXBJDTCHo23lXxxxA2M",
          authDomain: "concrete-domain-383905.firebaseapp.com",
          projectId: "concrete-domain-383905",
          storageBucket: "concrete-domain-383905.firebasestorage.app",
          messagingSenderId: "626887947873",
          appId: "1:626887947873:web:a3598c7e542678f1ec9c20",
          measurementId: "G-JLHHPW855R"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'book-club-quiz-default';
        
        // --- UI Elements ---
        const views = {
            initial: document.getElementById('initial-view'),
            howToPlay: document.getElementById('how-to-play-view'),
            hostSetup: document.getElementById('host-setup-view'),
            playerJoin: document.getElementById('player-join-view'),
            lobby: document.getElementById('lobby-view'),
            questionSubmission: document.getElementById('question-submission-view'),
            gameplay: document.getElementById('gameplay-view'),
            hostGameplay: document.getElementById('host-gameplay-view'),
            scoreboard: document.getElementById('scoreboard-view')
        };

        const userIdDisplay = document.getElementById('user-id-display');

        // --- Utility Functions ---
        function switchView(viewName) {
            Object.values(views).forEach(view => view.classList.remove('active'));
            if (views[viewName]) {
                views[viewName].classList.add('active');
            }
        }

        function generateShortId(length = 5) {
            const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789'; // Omitted O and 0 to avoid confusion
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        // --- Main App Logic ---

        // 1. Initialize Firebase and Authenticate User
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;

                        // Check for gameId in URL to auto-join
                        const urlParams = new URLSearchParams(window.location.search);
                        const gameIdFromUrl = urlParams.get('gameId');
                        if (gameIdFromUrl) {
                            switchView('playerJoin');
                            document.getElementById('game-id-input').value = gameIdFromUrl.toUpperCase();
                        }

                    } else {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                         } else {
                            await signInAnonymously(auth);
                         }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // A user-friendly error display could be added here
            }
        }

        // 2. Game State Management (listening to Firestore)
        function listenToGame(gameId) {
            if (gameUnsubscribe) gameUnsubscribe();

            const gameRef = doc(db, `artifacts/${appId}/public/data/bookClubGames`, gameId);
            gameUnsubscribe = onSnapshot(gameRef, (docSnap) => {
                if (!docSnap.exists()) {
                    // This is triggered when the host deletes the game.
                    // All players will reset to the initial view.
                    resetToInitialView();
                    return;
                }
                
                const gameData = docSnap.data();
                currentGameData = gameData; // Update global game data
                updateUI(gameData);
            });
        }

        // 3. UI Updates based on Game State
        function updateUI(gameData) {
            // Update host name and player list in lobby
            document.getElementById('host-name-display').textContent = gameData.hostName || '...';
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            const playerCount = Object.keys(gameData.players).length;
            if (playerCount === 0) {
                 playerList.innerHTML = '<p class="text-gray-500 text-center">No players have joined yet.</p>';
            } else {
                const sortedPlayers = Object.values(gameData.players).sort((a,b) => b.score - a.score);
                sortedPlayers.forEach(player => {
                    const playerEl = document.createElement('div');
                    playerEl.className = 'flex items-center space-x-2';
                    const playerName = player.name || `Player ${player.id.substring(0,6)}`;
                    playerEl.innerHTML = `<span class="font-semibold text-gray-800">👤 ${playerName}</span> <span class="text-sm text-gray-500">(Score: ${player.score})</span>`;
                    playerList.appendChild(playerEl);
                });
            }

            // Show host controls and invite info based on role
            const hostControls = document.getElementById('host-controls');
            const playerWaitMessage = document.getElementById('player-wait-message');
            const inviteContainer = document.getElementById('invite-container');
            const lobbyTitle = document.getElementById('lobby-title');

            if (userId === gameData.hostId) {
                hostControls.classList.remove('hidden');
                playerWaitMessage.textContent = 'You are the host. Start the game when everyone is ready.';
                
                inviteContainer.classList.remove('hidden');
                lobbyTitle.textContent = 'Game Lobby';

            } else {
                hostControls.classList.add('hidden');
                playerWaitMessage.textContent = 'The host will start the game soon. You can see new players join in real-time.';
                
                inviteContainer.classList.add('hidden');
                lobbyTitle.textContent = "You're In!";
            }


            // State machine for views
            switch (gameData.state) {
                case 'lobby':
                    switchView('lobby');
                    
                    // Generate QR Code only for the host
                    if (userId === gameData.hostId) {
                        document.getElementById('game-id-display').textContent = gameData.id;
                        const qrCodeContainer = document.getElementById('qrcode');
                        qrCodeContainer.innerHTML = ''; // Clear previous QR code
                        const joinLink = `${window.location.href.split('?')[0]}?gameId=${gameData.id}`;
                        new QRCode(qrCodeContainer, {
                            text: joinLink,
                            width: 160,
                            height: 160,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                    }
                    break;
                case 'submitting':
                    switchView('questionSubmission');
                    startSubmissionTimer(gameData.submissionEndTime);

                    const subViewTitle = document.getElementById('submission-view-title');
                    const playerContent = document.getElementById('player-submission-content');
                    const hostContent = document.getElementById('host-submission-content');

                    if (userId === gameData.hostId) {
                        subViewTitle.textContent = 'Question Submission';
                        playerContent.classList.add('hidden');
                        hostContent.classList.remove('hidden');

                        document.getElementById('total-questions-submitted').textContent = gameData.questions.length;
                        
                        const submittedQuestionsList = document.getElementById('submitted-questions-list');
                        submittedQuestionsList.innerHTML = ''; // Clear the list

                        if (gameData.questions.length === 0) {
                            submittedQuestionsList.innerHTML = '<p class="text-gray-500 text-center italic py-4">No questions have been submitted yet.</p>';
                        } else {
                            // Reverse to show newest first
                            [...gameData.questions].reverse().forEach(q => { 
                                const authorName = gameData.players[q.authorId]?.name || 'Unknown Player';

                                const questionEl = document.createElement('div');
                                questionEl.className = 'p-3 bg-white rounded-lg shadow-sm border';
                                
                                let optionsHTML = '<ul class="list-disc list-inside mt-2 text-sm text-gray-600 space-y-1">';
                                // Ensure consistent order for options
                                const sortedOptionKeys = Object.keys(q.options).sort();
                                sortedOptionKeys.forEach(key => {
                                     const isCorrect = key === q.correct;
                                     optionsHTML += `<li class="${isCorrect ? 'font-bold text-green-600' : ''}">${key}: ${q.options[key]} ${isCorrect ? '✓' : ''}</li>`;
                                });
                                optionsHTML += '</ul>';

                                questionEl.innerHTML = `
                                    <p class="font-semibold text-gray-800">${q.text}</p>
                                    <p class="text-xs text-gray-500 font-medium">Submitted by: <span class="font-bold">${authorName}</span></p>
                                    ${optionsHTML}
                                `;
                                submittedQuestionsList.appendChild(questionEl);
                            });
                        }

                    } else { // It's a player
                        subViewTitle.textContent = 'Submit Your Questions';
                        playerContent.classList.remove('hidden');
                        hostContent.classList.add('hidden');
                        
                        const myQuestionsCount = gameData.questions.filter(q => q.authorId === userId).length;
                        document.getElementById('questions-submitted-count').textContent = myQuestionsCount;
                    }
                    break;
                case 'playing':
                    startGameplayTimer(gameData.gameplayEndTime);
                    if (userId === gameData.hostId) {
                        switchView('hostGameplay');
                        updateLiveLeaderboard(gameData.players);
                    } else {
                        // Player logic
                        if (isPlayerFinished) {
                            // If player is finished, keep them on their "You're Done" screen
                             if (!views.gameplay.classList.contains('active')) switchView('gameplay');
                             document.getElementById('question-container').classList.add('hidden');
                             document.getElementById('player-finished-container').classList.remove('hidden');
                            break;
                        }

                        if (!views.gameplay.classList.contains('active')) {
                            if (gameData.questions.length > 0) {
                                prepareGameplay(gameData);
                                switchView('gameplay');
                            } else {
                                switchView('scoreboard');
                                displayFinalScores(gameData.players);
                            }
                        }
                    }
                    break;
                case 'finished':
                    switchView('scoreboard');
                    displayFinalScores(gameData.players);
                    break;
            }
        }
        
        function updateLiveLeaderboard(players) {
            const leaderboardList = document.getElementById('live-leaderboard-list');
            leaderboardList.innerHTML = '';
            const sortedPlayers = Object.values(players).sort((a, b) => b.score - a.score);

            if (sortedPlayers.length === 0) {
                leaderboardList.innerHTML = '<p class="text-gray-500 text-center">Waiting for players to score...</p>';
                return;
            }

            sortedPlayers.forEach((player, index) => {
                const playerEl = document.createElement('div');
                playerEl.className = 'flex justify-between items-center p-2 rounded-lg';
                let medal = '';
                if(index === 0) {
                     playerEl.classList.add('bg-yellow-100');
                     medal = '🥇';
                } else if (index === 1) {
                     playerEl.classList.add('bg-gray-200');
                     medal = '🥈';
                } else if (index === 2) {
                     playerEl.classList.add('bg-yellow-50');
                     medal = '🥉';
                } else {
                    playerEl.classList.add('bg-gray-50');
                }

                playerEl.innerHTML = `
                    <span class="font-semibold text-gray-800"><span class="inline-block w-6 text-center mr-2">${medal || (index + 1) + '.'}</span> ${player.name}</span>
                    <span class="font-bold text-indigo-600">${player.score} pts</span>
                `;
                leaderboardList.appendChild(playerEl);
            });
        }

        // 4. Game Actions (triggered by user)
        document.getElementById('host-game-btn').addEventListener('click', () => switchView('hostSetup'));
        document.getElementById('join-game-btn').addEventListener('click', () => switchView('playerJoin'));
        document.getElementById('how-to-play-btn').addEventListener('click', () => switchView('howToPlay'));
        document.getElementById('back-to-initial-btn-host').addEventListener('click', resetToInitialView);
        document.getElementById('back-to-initial-btn-join').addEventListener('click', resetToInitialView);
        document.getElementById('back-to-initial-btn-rules').addEventListener('click', resetToInitialView);

        document.getElementById('create-game-btn').addEventListener('click', async () => {
            const playerName = document.getElementById('host-name-input').value.trim();
            if (!playerName) {
                alert("Please enter your name!");
                return;
            }

            const submissionTime = parseInt(document.getElementById('submission-time').value) * 60;
            const totalPlayTime = parseInt(document.getElementById('total-play-time').value) * 60;

            let newGameId;
            let gameExists = true;
            const gameCollRef = collection(db, `artifacts/${appId}/public/data/bookClubGames`);

            // This loop is a safeguard against the very rare case of an ID collision.
            while (gameExists) {
                newGameId = generateShortId();
                const gameDocRef = doc(gameCollRef, newGameId);
                const docSnap = await getDoc(gameDocRef);
                if (!docSnap.exists()) {
                    gameExists = false;
                }
            }

            currentGameId = newGameId;

            const gameData = {
                id: currentGameId,
                hostId: userId,
                hostName: playerName,
                config: { submissionTime, totalPlayTime },
                state: 'lobby', // lobby, submitting, playing, finished
                players: {}, // Host is not a player
                questions: [],
                submissionEndTime: null,
                gameplayEndTime: null,
            };

            await setDoc(doc(db, `artifacts/${appId}/public/data/bookClubGames`, currentGameId), gameData);
            listenToGame(currentGameId);
        });
        
        async function joinGameWithId(gameId, playerName) {
            if (!gameId || !userId || !playerName) {
                alert("Cannot join game. Missing info.");
                return;
            }

            const gameRef = doc(db, `artifacts/${appId}/public/data/bookClubGames`, gameId);
            const gameSnap = await getDoc(gameRef);

            if (gameSnap.exists()) {
                currentGameId = gameId;
                const gameData = gameSnap.data();
                if (!gameData.players[userId]) {
                     await updateDoc(gameRef, {
                        [`players.${userId}`]: { id: userId, name: playerName, score: 0 }
                    });
                }
                listenToGame(currentGameId);
                const cleanUrl = window.location.href.split('?')[0];
                window.history.replaceState({}, document.title, cleanUrl);
            } else {
                alert("Game ID not found.");
                const cleanUrl = window.location.href.split('?')[0];
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }

        document.getElementById('submit-join-game-btn').addEventListener('click', async () => {
            const gameId = document.getElementById('game-id-input').value.trim().toUpperCase();
            const playerName = document.getElementById('join-player-name-input').value.trim();

            if (!gameId || !playerName) {
                alert("Please enter your name and a Game ID.");
                return;
            }
            await joinGameWithId(gameId, playerName);
        });
        
        document.getElementById('copy-game-id-btn').addEventListener('click', () => {
            const gameId = document.getElementById('game-id-display').textContent;
            const joinLink = `${window.location.href.split('?')[0]}?gameId=${gameId}`;
            
            const tempInput = document.createElement('input');
            document.body.appendChild(tempInput);
            tempInput.value = joinLink;
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            alert('Game join link copied to clipboard!');
        });


        document.getElementById('start-game-btn').addEventListener('click', async () => {
            const gameRef = doc(db, `artifacts/${appId}/public/data/bookClubGames`, currentGameId);
            const gameSnap = await getDoc(gameRef);
            if(gameSnap.exists()) {
                const gameData = gameSnap.data();
                const submissionEndTime = Date.now() + gameData.config.submissionTime * 1000;
                await updateDoc(gameRef, {
                    state: 'submitting',
                    submissionEndTime: submissionEndTime
                });
            }
        });

        document.getElementById('question-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const questionText = document.getElementById('question-text').value;
            const options = {
                A: document.getElementById('option-a').value,
                B: document.getElementById('option-b').value,
                C: document.getElementById('option-c').value,
                D: document.getElementById('option-d').value,
            };
            const correctAnswer = document.getElementById('correct-answer').value;

            const questionData = {
                authorId: userId,
                text: questionText,
                options: options,
                correct: correctAnswer
            };

            const gameRef = doc(db, `artifacts/${appId}/public/data/bookClubGames`, currentGameId);
            // Atomically increment score
            const gameSnap = await getDoc(gameRef);
            const currentScore = gameSnap.data().players[userId]?.score || 0;

            await updateDoc(gameRef, {
                questions: arrayUnion(questionData),
                [`players.${userId}.score`]: currentScore + 10 // Award 10 points for submitting a question
            });

            document.getElementById('question-form').reset();
        });

        document.getElementById('play-again-btn').addEventListener('click', async () => {
            if (currentGameData && userId === currentGameData.hostId) {
                const gameRef = doc(db, `artifacts/${appId}/public/data/bookClubGames`, currentGameId);
                await deleteDoc(gameRef);
                // The onSnapshot listener will catch the deletion and reset the view for everyone.
            }
        });

        document.getElementById('end-game-now-btn').addEventListener('click', async () => {
            if (currentGameData && userId === currentGameData.hostId) {
                const gameRef = doc(db, `artifacts/${appId}/public/data/bookClubGames`, currentGameId);
                await updateDoc(gameRef, { state: 'finished' });
            }
        });

        // 5. Timers and Gameplay Logic
        function startSubmissionTimer(endTime) {
            if (countdownTimer) clearInterval(countdownTimer);
            
            const timerEl = document.getElementById('submission-timer');
            
            countdownTimer = setInterval(async () => {
                const remaining = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
                timerEl.textContent = formatTime(remaining);

                if (remaining === 0) {
                    clearInterval(countdownTimer);
                    // Host transitions the game to the next state
                    if (auth.currentUser && currentGameId) {
                        const gameRef = doc(db, `artifacts/${appId}/public/data/bookClubGames`, currentGameId);
                        const gameSnap = await getDoc(gameRef);
                        if (gameSnap.exists() && gameSnap.data().hostId === auth.currentUser.uid) {
                            const gameData = gameSnap.data();
                            const gameplayEndTime = Date.now() + gameData.config.totalPlayTime * 1000;
                            await updateDoc(gameRef, { 
                                state: 'playing',
                                gameplayEndTime: gameplayEndTime
                            });
                        }
                    }
                }
            }, 1000);
        }

        function startGameplayTimer(endTime) {
            if (gameplayTimer) clearInterval(gameplayTimer);
            
            const playerTimerEl = document.getElementById('game-timer');
            const hostTimerEl = document.getElementById('host-game-timer');
            
            gameplayTimer = setInterval(async () => {
                const remaining = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
                const formattedTime = formatTime(remaining);
                
                if (playerTimerEl) playerTimerEl.textContent = formattedTime;
                if (hostTimerEl) hostTimerEl.textContent = formattedTime;

                if (remaining === 0) {
                    clearInterval(gameplayTimer);
                    // Host transitions the game to the finished state
                    if (auth.currentUser && currentGameId) {
                        const gameRef = doc(db, `artifacts/${appId}/public/data/bookClubGames`, currentGameId);
                        const gameSnap = await getDoc(gameRef);
                        if (gameSnap.exists() && gameSnap.data().hostId === auth.currentUser.uid) {
                            await updateDoc(gameRef, { state: 'finished' });
                        }
                    }
                }
            }, 1000);
        }
        
        function prepareGameplay(gameData) {
            isPlayerFinished = false; // Reset finished state for new round
            // Player sees questions from others
            playerQuestions = gameData.questions.filter(q => q.authorId !== userId);
            playerQuestions.sort(() => Math.random() - 0.5); // Shuffle questions
            currentQuestionIndex = 0;

            if(playerQuestions.length > 0) {
                document.getElementById('question-container').classList.remove('hidden');
                document.getElementById('player-finished-container').classList.add('hidden');
                document.getElementById('waiting-for-questions').classList.add('hidden');
                displayQuestion();
            } else {
                 document.getElementById('question-container').classList.add('hidden');
                 document.getElementById('waiting-for-questions').classList.remove('hidden');
            }
        }

        function displayQuestion() {
            if (currentQuestionIndex >= playerQuestions.length) {
                // Player has finished all their questions.
                isPlayerFinished = true; // Mark player as finished
                document.getElementById('question-container').classList.add('hidden');
                document.getElementById('player-finished-container').classList.remove('hidden');
                return;
            }
            
            const q = playerQuestions[currentQuestionIndex];
            document.getElementById('current-question-number').textContent = currentQuestionIndex + 1;
            document.getElementById('total-questions-number').textContent = playerQuestions.length;
            document.getElementById('game-question-text').textContent = q.text;
            document.getElementById('feedback-message').textContent = '';

            const optionsContainer = document.getElementById('game-options');
            optionsContainer.innerHTML = '';
            
            const sortedKeys = Object.keys(q.options).sort();

            sortedKeys.forEach(key => {
                const value = q.options[key];
                const button = document.createElement('button');
                button.className = 'btn option-btn p-4 text-left w-full';
                button.textContent = `${key}: ${value}`;
                button.dataset.option = key;
                button.onclick = () => handleAnswer(key, q.correct);
                optionsContainer.appendChild(button);
            });
        }

        async function handleAnswer(selectedOption, correctOption) {
            const options = document.querySelectorAll('#game-options .option-btn');
            
            options.forEach(btn => {
                btn.disabled = true;
                const optionKey = btn.dataset.option;
                if (optionKey === correctOption) {
                    btn.classList.add('correct');
                }
                if (optionKey === selectedOption && selectedOption !== correctOption) {
                    btn.classList.add('incorrect');
                }
            });
            
            if (selectedOption === correctOption) {
                document.getElementById('feedback-message').textContent = 'Correct!';
                document.getElementById('feedback-message').className = 'mt-6 text-xl font-bold text-green-600';
                
                const gameRef = doc(db, `artifacts/${appId}/public/data/bookClubGames`, currentGameId);
                const gameSnap = await getDoc(gameRef);
                if(gameSnap.exists()){
                    const currentScore = gameSnap.data().players[userId].score || 0;
                    await updateDoc(gameRef, {
                        [`players.${userId}.score`]: currentScore + 10 // 10 points for correct answer
                    });
                }
                
            } else if (selectedOption) {
                document.getElementById('feedback-message').textContent = 'Wrong answer.';
                 document.getElementById('feedback-message').className = 'mt-6 text-xl font-bold text-red-600';
            }

            currentQuestionIndex++;
            setTimeout(() => displayQuestion(), 2000); // Wait 2 seconds before next question
        }
        
        function displayFinalScores(players) {
            const sortedPlayers = Object.values(players).sort((a, b) => b.score - a.score);

            const podium1 = document.getElementById('podium-1');
            const podium2 = document.getElementById('podium-2');
            const podium3 = document.getElementById('podium-3');
            const runnersUpList = document.getElementById('runners-up-list');

            // Clear previous scores
            podium1.innerHTML = '';
            podium2.innerHTML = '';
            podium3.innerHTML = '';
            runnersUpList.innerHTML = '';

            podium1.classList.add('hidden');
            podium2.classList.add('hidden');
            podium3.classList.add('hidden');

            // 1st Place
            if (sortedPlayers[0]) {
                podium1.innerHTML = `<div class="text-4xl mb-2">🥇</div><div class="podium-name">${sortedPlayers[0].name}</div><div class="podium-score">${sortedPlayers[0].score} pts</div>`;
                podium1.classList.remove('hidden');
            }

            // 2nd Place
            if (sortedPlayers[1]) {
                podium2.innerHTML = `<div class="text-3xl mb-2">🥈</div><div class="podium-name">${sortedPlayers[1].name}</div><div class="podium-score">${sortedPlayers[1].score} pts</div>`;
                podium2.classList.remove('hidden');
            }

            // 3rd Place
            if (sortedPlayers[2]) {
                podium3.innerHTML = `<div class="text-3xl mb-2">🥉</div><div class="podium-name">${sortedPlayers[2].name}</div><div class="podium-score">${sortedPlayers[2].score} pts</div>`;
                podium3.classList.remove('hidden');
            }
            
            // Runners-up (4th place and beyond)
            if (sortedPlayers.length > 3) {
                const runnersUpTitle = document.createElement('h3');
                runnersUpTitle.className = 'text-lg font-bold text-gray-700 mt-4 border-t pt-4';
                runnersUpTitle.textContent = 'Leaderboard';
                runnersUpList.appendChild(runnersUpTitle);

                sortedPlayers.slice(3).forEach((player, index) => {
                    const playerEl = document.createElement('div');
                    playerEl.className = 'flex justify-between items-center p-2 rounded-lg bg-gray-50';
                    playerEl.innerHTML = `
                        <span class="font-semibold text-gray-800"><span class="inline-block w-6 text-center mr-2 text-gray-500">${index + 4}.</span> ${player.name}</span>
                        <span class="font-bold text-indigo-600">${player.score} pts</span>
                    `;
                    runnersUpList.appendChild(playerEl);
                });
            }


            const playAgainBtn = document.getElementById('play-again-btn');
            if (currentGameData && userId === currentGameData.hostId) {
                playAgainBtn.classList.remove('hidden');
            } else {
                playAgainBtn.classList.add('hidden');
            }
        }
        
        function resetToInitialView() {
            if (gameUnsubscribe) gameUnsubscribe();
            if (countdownTimer) clearInterval(countdownTimer);
            if (gameplayTimer) clearInterval(gameplayTimer);

            currentGameId = null;
            currentGameData = null;
            playerQuestions = [];
            currentQuestionIndex = 0;
            isPlayerFinished = false;
            
            // Clear inputs and dynamic content
            document.getElementById('game-id-input').value = '';
            document.getElementById('question-form').reset();
            document.getElementById('player-list').innerHTML = '';
            document.getElementById('questions-submitted-count').textContent = '0';
            document.getElementById('host-name-input').value = '';
            document.getElementById('join-player-name-input').value = '';


            switchView('initial');
        }


        // Start the application
        initialize();
    </script>
</body>
</html>

